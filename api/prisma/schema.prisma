// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

// Skema menejemen user
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String    @id @default(uuid(7))
  email     String    @unique
  password  String
  name      String
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  lastLogin DateTime?

  profile              Profile?
  userRoles            UserRole[]
  teachingClasses      Class[]              @relation("PengajarClasses")
  enrollments          Enrollment[]
  assessmentsGiven     Assessment[]         @relation("Evaluator")
  notifications        Notification[]
  announcementsCreated Announcement[]       @relation("AnnouncementCreator")
  sentMessages         Message[]            @relation("MessageSender")
  receivedMessages     Message[]            @relation("MessageRecipient")

  @@index([email])
  @@index([isActive])
  @@map("users")
}

model Profile {
  id          String    @id @default(uuid(7))
  userId      String    @unique
  phoneNumber String?
  address     String?
  dateOfBirth DateTime?
  gender      String? // 'Laki', 'Perempuan'
  photoUrl    String?
  bio         String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("profiles")
}

model Role {
  id          String   @id @default(uuid(7))
  name        String   @unique // 'admin', 'pengajar', 'mahasiswa'
  description String?
  permissions Json?
  createdAt   DateTime @default(now())

  // Relations
  userRoles UserRole[]

  @@index([name])
  @@map("roles")
}

model UserRole {
  id         String   @id @default(uuid(7))
  userId     String
  roleId     String
  assignedAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

// Skema kelas 

model Class {
  id                String    @id @default(uuid(7))
  name              String
  code              String    @unique
  description       String?
  pengajarId        String
  level             String // 'pemula', 'menengah', 'lanjut'
  type              String // 'tahsin', 'tajwid', 'tahfidz'
  capacity          Int       @default(20)
  currentEnrollment Int       @default(0)
  status            String    @default("active") // 'active', 'inactive', 'completed'
  startDate         DateTime
  endDate           DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt


  // Relations
  pengajar        User             @relation("PengajarClasses", fields: [pengajarId], references: [id])
  enrollments     Enrollment[]
  schedules       Schedule[]
  classMaterials  ClassMaterial[]
  achievements    Achievement[]
  announcements   Announcement[]

  @@index([pengajarId])
  @@index([status])
  @@index([type])
  @@index([level])
  @@map("classes")
}

model Enrollment {
  id          String    @id @default(uuid(7))
  userId      String
  classId     String
  status      String    @default("active") // 'active', 'completed', 'dropped'
  enrolledAt  DateTime  @default(now())
  completedAt DateTime?
  finalGrade  Float?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt


  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  class        Class         @relation(fields: [classId], references: [id], onDelete: Cascade)
  attendances  Attendance[]
  progresses   Progress[]
  assessments  Assessment[]
  achievements Achievement[]

  @@unique([userId, classId])
  @@index([userId])
  @@index([classId])
  @@index([status])
  @@map("enrollments")
}

model Schedule {
  id           String    @id @default(uuid(7))
  classId      String
  dayOfWeek    String?   // 'senin', 'selasa', etc. for recurring
  startTime    String    // Store as HH:mm format
  endTime      String    // Store as HH:mm format
  location     String?
  roomNumber   String?
  isRecurring  Boolean   @default(true)
  specificDate DateTime? // For non-recurring schedules
  status       String    @default("scheduled") // 'scheduled', 'completed', 'cancelled'
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  class       Class        @relation(fields: [classId], references: [id], onDelete: Cascade)
  attendances Attendance[]

  @@index([classId])
  @@index([specificDate])
  @@index([status])
  @@map("schedules")
}

model Attendance {
  id             String   @id @default(uuid(7))
  enrollmentId   String
  scheduleId     String
  attendanceDate DateTime
  checkInTime    String?  // Store as HH:mm:ss format
  status         String   // 'present', 'absent', 'late', 'excused'
  notes          String?
  createdAt      DateTime @default(now())


  // Relations
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  schedule   Schedule   @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, scheduleId, attendanceDate])
  @@index([enrollmentId])
  @@index([scheduleId])
  @@index([attendanceDate])
  @@index([status])
  @@map("attendances")
}

model Material {
  id          String   @id @default(uuid(7))
  title       String
  description String?
  category    String   // 'tahsin', 'tajwid', 'tahfidz', 'teori'
  contentType String   // 'pdf', 'video', 'audio', 'text'
  fileUrl     String?
  duration    Int?     // in minutes
  orderIndex  Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  classMaterials ClassMaterial[]
  progresses     Progress[]

  @@index([category])
  @@index([contentType])
  @@map("materials")
}

model ClassMaterial {
  id         String   @id @default(uuid(7))
  classId    String
  materialId String
  orderIndex Int      @default(0)
  isRequired Boolean  @default(true)
  assignedAt DateTime @default(now())

  // Relations
  class    Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  material Material @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@unique([classId, materialId])
  @@index([classId])
  @@index([materialId])
  @@map("class_materials")
}

model Progress {
  id                   String    @id @default(uuid(7))
  enrollmentId         String
  materialId           String?
  juzNumber            Int?
  surahName            String?
  ayahStart            Int?
  ayahEnd              Int?
  completionPercentage Float     @default(0)
  status               String    @default("not_started") // 'not_started', 'in_progress', 'completed', 'mastered'
  lastStudiedAt        DateTime?
  notes                String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // Relations
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  material   Material?  @relation(fields: [materialId], references: [id], onDelete: SetNull)

  @@index([enrollmentId])
  @@index([materialId])
  @@index([status])
  @@index([juzNumber])
  @@map("progresses")
}

model Assessment {
  id                 String   @id @default(uuid(7))
  enrollmentId       String
  evaluatorId        String
  assessmentType     String   // 'tahsin', 'tajwid', 'tahfidz', 'ujian'
  category           String   // 'harian', 'mingguan', 'bulanan', 'semester'
  score              Float
  maxScore           Float    @default(100)
  grade              String?  // 'A', 'B', 'C', 'D', 'E'
  criteria           Json?    // Detailed evaluation criteria
  feedback           String?
  audioRecordingUrl  String?
  assessmentDate     DateTime
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  evaluator  User       @relation("Evaluator", fields: [evaluatorId], references: [id])

  @@index([enrollmentId])
  @@index([evaluatorId])
  @@index([assessmentType])
  @@index([assessmentDate])
  @@map("assessments")
}

model Achievement {
  id           String   @id @default(uuid(7))
  enrollmentId String
  classId      String
  title        String
  description  String?
  badgeType    String   // 'completion', 'excellence', 'consistency', 'milestone'
  iconUrl      String?
  earnedAt     DateTime @default(now())
  createdAt    DateTime @default(now())

  // Relations
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  class      Class      @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@index([enrollmentId])
  @@index([classId])
  @@index([badgeType])
  @@map("achievements")
}

// Komunikasi dan notifikasi

model Notification {
  id       String    @id @default(uuid(7))
  userId   String
  title    String
  message  String
  type     String    // 'schedule', 'assessment', 'announcement', 'reminder'
  priority String    @default("medium") // 'low', 'medium', 'high'
  isRead   Boolean   @default(false)
  metadata Json?
  createdAt DateTime @default(now())
  readAt   DateTime?

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@index([createdAt])
  @@map("notifications")
}

model Announcement {
  id             String    @id @default(uuid(7))
  createdBy      String
  classId        String?
  title          String
  content        String
  targetAudience String    // 'all', 'pengajar', 'mahasiswa', 'class_specific'
  isPinned       Boolean   @default(false)
  publishedAt    DateTime  @default(now())
  expiresAt      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  creator User   @relation("AnnouncementCreator", fields: [createdBy], references: [id])
  class   Class? @relation(fields: [classId], references: [id], onDelete: SetNull)

  @@index([createdBy])
  @@index([classId])
  @@index([targetAudience])
  @@index([publishedAt])
  @@index([isPinned])
  @@map("announcements")
}

model Message {
  id          String    @id @default(uuid(7))
  senderId    String
  recipientId String
  subject     String?
  content     String
  isRead      Boolean   @default(false)
  replyToId   String?
  sentAt      DateTime  @default(now())
  readAt      DateTime?

  // Relations
  sender    User     @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  recipient User     @relation("MessageRecipient", fields: [recipientId], references: [id], onDelete: Cascade)
  replyTo   Message? @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies   Message[] @relation("MessageReplies")

  @@index([senderId])
  @@index([recipientId])
  @@index([isRead])
  @@index([sentAt])
  @@map("messages")
}